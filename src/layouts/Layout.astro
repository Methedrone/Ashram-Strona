---
import { getLangFromUrl, useTranslations } from '../i18n/utils';
import Schema from '../components/Schema.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';

interface Props {
  title: string;
  description?: string;
  ogImage?: string;
  schema?: Record<string, any>;
}

const { title, description: customDescription, ogImage, schema } = Astro.props;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const siteUrl = 'https://babaji.org.pl';
const pageUrl = new URL(Astro.url.pathname, siteUrl).href;
const description = customDescription || t('common.description');
const currentPath = Astro.url.pathname;

// Generate hreflang alternate URLs
const alternateLocales = ['pl', 'en'];
const currentPathWithoutLocale = currentPath.replace(/^\/(pl|en)/, '');
const hreflangs = alternateLocales.map(locale => ({
  locale,
  url: `${siteUrl}/${locale}${currentPathWithoutLocale}`
}));

// OG image with default fallback
const ogImageUrl = ogImage ? `${siteUrl}${ogImage}` : `${siteUrl}/og-image.jpg`;

const defaultSchema: Record<string, any> = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "ReligiousOrganization",
      "name": "Ashram Babaji",
      "url": siteUrl,
      "logo": `${siteUrl}/favicon.svg`,
      "address": {
        "@type": "PostalAddress",
        "streetAddress": "Mąkolno 129",
        "addressLocality": "Mąkolno",
        "postalCode": "57-250",
        "addressCountry": "PL"
      }
    },
    {
      "@type": "WebSite",
      "name": "Ashram Babaji",
      "url": siteUrl,
      "potentialAction": {
        "@type": "SearchAction",
        "target": `${siteUrl}/search?q={search_term_string}`,
        "query-input": "required name=search_term_string"
      }
    }
  ]
};

const schemaOrg: Record<string, any> = { ...defaultSchema };
if (schema) {
  if (schema['@graph']) {
    schemaOrg['@graph'].push(...schema['@graph']);
  } else {
    schemaOrg['@graph'].push(schema);
  }
}
---

<!doctype html>
<html lang={lang}>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <link rel="manifest" href="/manifest.json" />
		<meta name="generator" content={Astro.generator} />
		<title>{title} | Ashram</title>
        
        <!-- SEO -->
        <meta name="description" content={description} />
        <link rel="canonical" href={pageUrl} />
        <link rel="sitemap" href="/sitemap-index.xml" />
        
        <!-- Hreflang -->
        {hreflangs.map(({ locale, url }) => (
          <link rel="alternate" hreflang={locale} href={url} />
        ))}
        <link rel="alternate" hreflang="x-default" href={hreflangs[0].url} />

        <!-- OpenGraph -->
        <meta property="og:type" content="website" />
        <meta property="og:url" content={pageUrl} />
        <meta property="og:title" content={`${title} | Ashram`} />
        <meta property="og:description" content={description} />
        <meta property="og:image" content={ogImageUrl} />
        <meta property="og:image:width" content="1200" />
        <meta property="og:image:height" content="630" />
        <meta property="og:image:alt" content={`${title} - Ashram Babaji`} />
        <meta property="og:locale" content={lang === 'pl' ? 'pl_PL' : 'en_US'} />
        {alternateLocales.filter(l => l !== lang).map(altLang => (
          <meta property="og:locale:alternate" content={altLang === 'pl' ? 'pl_PL' : 'en_US'} />
        ))}

        <!-- Twitter -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:title" content={`${title} | Ashram`} />
        <meta name="twitter:description" content={description} />
        <meta name="twitter:image" content={ogImageUrl} />

        <!-- Schema.org -->
        <Schema schema={schemaOrg} />
	</head>
	<body>
		<Header activePath={currentPath} />
		<main>
			<h1>{title}</h1>
			<slot />
		</main>
		<Footer />
	</body>
</html>

<style is:global>
	@import "../styles/global.css";
</style>
