---
import { getLangFromUrl, useTranslations, translatePath } from "../i18n/utils";

interface Props {
  activePath?: string;
}

const { activePath } = Astro.props;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const navItems = [
  { href: lang === 'pl' ? '/' : `/${lang}`, text: t("nav.home") },
  { href: lang === 'pl' ? '/about' : `/${lang}/about`, text: t("nav.about") },
  { href: lang === 'pl' ? '/teachings' : `/${lang}/teachings`, text: t("nav.teachings") },
  { href: lang === 'pl' ? '/events' : `/${lang}/events`, text: t("nav.events") },
  { href: lang === 'pl' ? '/gallery' : `/${lang}/gallery`, text: t("nav.gallery") },
  { href: lang === 'pl' ? '/contact' : `/${lang}/contact`, text: t("nav.contact") },
  { href: lang === 'pl' ? '/donations' : `/${lang}/donations`, text: t("nav.donations") },
];

// Language switcher logic
const currentPath = activePath || Astro.url.pathname;
const targetLang = lang === "pl" ? "en" : "pl";
const switchPath = translatePath(currentPath, lang, targetLang);

const switchText = lang === "pl" ? "English" : "Polski";
---

<header>
    <div class="header-container">
        <a href={lang === 'pl' ? '/' : `/${lang}`} class="logo">Ashram Babaji</a>
        
        <button 
            type="button"
            id="menu-toggle"
            class="menu-icon"
            aria-expanded="false"
            aria-controls="main-navigation"
            aria-label={t("nav.toggle") || "Toggle navigation"}
        >
            <span class="bar"></span>
            <span class="bar"></span>
            <span class="bar"></span>
        </button>

        <nav id="main-navigation" data-visible="false">
            <ul class="nav-main">
                {navItems.map(item => {
                    const normalizedHref = item.href.replace(/\/$/, '');
                    return (
                    <li>
                        <a 
                            href={item.href} 
                            class={currentPath === normalizedHref ? "active" : ""}
                            aria-current={currentPath === normalizedHref ? "page" : undefined}
                        >
                            {item.text}
                        </a>
                    </li>
                )})}
            </ul>
            <div class="nav-language">
                <a href={switchPath} class="lang-switch" aria-label={`Switch to ${switchText}`}>
                    <span class="lang-flag" aria-hidden="true">{lang === 'pl' ? 'ðŸ‡¬ðŸ‡§' : 'ðŸ‡µðŸ‡±'}</span>
                    <span class="lang-text">{switchText}</span>
                </a>
            </div>
        </nav>
    </div>
</header>

<script>
    const menuToggle = document.getElementById("menu-toggle");
    const nav = document.getElementById("main-navigation");
    const headerContainer = document.querySelector(".header-container");

    if (menuToggle && nav && headerContainer) {
        menuToggle.addEventListener("click", () => {
            const isExpanded = menuToggle.getAttribute("aria-expanded") === "true";
            
            // Toggle state
            menuToggle.setAttribute("aria-expanded", (!isExpanded).toString());
            nav.setAttribute("data-visible", (!isExpanded).toString());
            headerContainer.classList.toggle("menu-open");
        });

        // Keyboard navigation (Escape to close, Tab trap)
        document.addEventListener("keydown", (e) => {
            const isMenuOpen = headerContainer.classList.contains("menu-open");
            if (!isMenuOpen) return;

            if (e.key === "Escape") {
                menuToggle.click();
                menuToggle.focus();
                return;
            }

            if (e.key === "Tab") {
                const navLinks = Array.from(nav.querySelectorAll("a"));
                const focusables = [menuToggle, ...navLinks];
                const first = focusables[0];
                const last = focusables[focusables.length - 1];

                if (e.shiftKey) {
                    if (document.activeElement === first) {
                        e.preventDefault();
                        last.focus();
                    }
                } else {
                    if (document.activeElement === last) {
                        e.preventDefault();
                        first.focus();
                    }
                }
            }
        });
    }
</script>

<style>
    header {
        /* Warm gradient instead of flat */
        background: linear-gradient(
            180deg,
            rgba(250, 248, 245, 0.98) 0%,
            rgba(255, 252, 247, 0.95) 100%
        );
        border-bottom: 1px solid rgba(212, 175, 119, 0.2);
        position: sticky;
        top: 0;
        z-index: 1000;
        box-shadow: 0 2px 8px rgba(212, 175, 119, 0.08); /* Warm shadow */
        backdrop-filter: blur(8px);
    }

    .header-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: var(--spacing-md) var(--spacing-lg);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: var(--spacing-md);
    }

    .logo {
        position: relative;
        display: inline-block;
        font-family: var(--font-family-serif);
        font-size: 1.15rem;
        font-weight: 600;
        color: var(--color-gold);
        text-decoration: none;
        letter-spacing: 0.02em;
        z-index: 1001;
        flex: 0 0 auto;
        max-width: 240px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Decorative underline for logo */
    .logo::after {
        content: '';
        position: absolute;
        bottom: -4px;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(
            90deg,
            transparent 0%,
            var(--color-gold) 50%,
            transparent 100%
        );
        opacity: 0.4;
    }

    /* Mobile Menu Toggle */
    .menu-icon {
        display: none;
        flex-direction: column;
        justify-content: space-between;
        width: 30px;
        height: 18px;
        cursor: pointer;
        z-index: 1001;
        background: transparent;
        border: none;
        padding: 0;
    }

    .bar {
        width: 100%;
        height: 2px;
        background-color: var(--color-text-light);
        border-radius: 4px; /* More organic */
        transition: all 0.3s ease;
    }

    nav {
        display: flex;
        align-items: center;
        gap: var(--spacing-lg);
        flex: 1 1 auto; /* allow nav to take remaining space */
        min-width: 0;   /* prevent overflowing flex children */
        justify-content: flex-end; /* align nav items to the right */
    }

    nav ul {
        display: flex;
        gap: var(--spacing-md);
        list-style: none;
        padding: 0;
        margin: 0;
        align-items: center;
        flex-wrap: nowrap; /* Prevent wrapping on desktop */
        display: flex;
        gap: var(--spacing-md);
        list-style: none;
        padding: 0;
        margin: 0;
        align-items: center;
    }

    .nav-language {
        display: flex;
        align-items: center;
    }

    nav a {
        text-decoration: underline;
        text-decoration-color: transparent;
        text-underline-offset: 4px;
        text-decoration-thickness: 1px;
        color: var(--color-text);
        font-weight: 400;
        transition: text-decoration-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        padding: var(--spacing-xs) var(--spacing-sm);
        border-bottom: 2px solid transparent; /* Reserve space for active border */
        white-space: nowrap; /* Prevent menu item text wrapping */
        flex-shrink: 0;     /* Prevent menu items from shrinking */
        text-decoration: underline;
        text-decoration-color: transparent;
        text-underline-offset: 4px;
        text-decoration-thickness: 1px;
        color: var(--color-text);
        font-weight: 400;
        transition: text-decoration-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        padding: var(--spacing-xs) var(--spacing-sm);
        border-bottom: 2px solid transparent; /* Reserve space for active border */
    }

    nav a:hover {
        color: var(--color-orange);
        text-decoration-color: var(--color-orange);
        text-decoration-thickness: 2px;
    }

    nav a.active {
        color: var(--color-orange);
        border-bottom-color: var(--color-orange);
        text-decoration: none;
        text-shadow: 0 0 8px rgba(230, 168, 104, 0.2); /* Golden glow */
    }

    nav a:focus-visible {
        outline: 2px solid var(--color-orange);
        outline-offset: 3px;
    }

    .lang-switch {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        color: var(--color-text-light) !important;
        border: 1px solid var(--color-border);
        padding: 0.375rem 0.875rem;
        border-radius: 20px;
        text-decoration: none !important;
        transition: all 0.2s ease;
    }

    .lang-switch:hover {
        border-color: var(--color-orange);
        color: var(--color-orange) !important;
        background-color: var(--color-orange-tint);
    }

    .lang-flag {
        font-size: 1.1rem;
        line-height: 1;
    }

    .lang-text {
        font-size: 0.9rem;
    }

    /* Responsive Styles */
    @media (max-width: 768px) {
        .menu-icon {
            display: flex;
        }

        nav {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background-color: var(--color-bg-warm);
            transform: translateY(-100%);
            opacity: 0;
            visibility: hidden;
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1),
                        opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1),
                        visibility 0s 0.35s;
            box-shadow: 0 4px 10px rgba(212, 175, 119, 0.15);
            z-index: 999;
            will-change: transform, opacity;
            border-bottom: 1px solid rgba(212, 175, 119, 0.2);
            flex-direction: column;
            padding: 1rem 0;
            gap: 0;
        }

        nav ul.nav-main {
            flex-direction: column;
            padding: 0;
            gap: 0;
            width: 100%;
        }

        .nav-language {
            width: 100%;
            padding: 1rem 0;
            border-top: 1px solid rgba(212, 175, 119, 0.2);
            margin-top: 0.5rem;
            justify-content: center;
        }

        nav li {
            width: 100%;
            text-align: center;
        }

        nav a {
            display: block;
            padding: 1rem;
            width: 100%;
            border-bottom: 1px solid rgba(212, 175, 119, 0.1);
            text-decoration: none;
        }

        nav a:hover {
            color: var(--color-orange);
            text-decoration: none;
            background-color: var(--color-bg-warm-alt);
            text-decoration-color: transparent;
        }
        
        nav a.active {
            border-bottom: 1px solid var(--color-orange);
            background-color: var(--color-bg-warm-alt);
        }
        
        nav a:not(.active) {
            border-bottom: 1px solid rgba(212, 175, 119, 0.1);
        }

        .header-container.menu-open nav {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
            transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1),
                        opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .header-container.menu-open .menu-icon .bar:nth-child(1) {
            transform: translateY(8px) rotate(45deg);
        }

        .header-container.menu-open .menu-icon .bar:nth-child(2) {
            opacity: 0;
        }

        .header-container.menu-open .menu-icon .bar:nth-child(3) {
            transform: translateY(-8px) rotate(-45deg);
        }
        
        .menu-icon:focus-visible {
            outline: 2px solid var(--color-orange);
            outline-offset: 4px;
        }
    }

    /* Slightly tighter logo cap on very wide screens */
    @media (min-width: 1200px) {
        .logo {
            max-width: 220px;
            font-size: 1.15rem;
        }
    }
</style>